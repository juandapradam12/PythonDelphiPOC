unit PyEngineService;

interface

uses
  System.SysUtils, System.Classes, System.IOUtils, Winapi.Windows,
  PythonEngine, VarPyth;

type
  TPyEngineService = class
  private
    FPython: TPythonEngine;
    function ProjectRootFromExe: string;
    procedure AddToSysPath(const Path: string);
  public
    constructor Create;
    destructor Destroy; override;
    procedure EnsureReady;
    property Python: TPythonEngine read FPython;
  end;

var
  PyEngineService: TPyEngineService;

implementation

{ TPyEngineService }

constructor TPyEngineService.Create;
var
  RootDir, PyEmbed, PyApp: string;
begin
  RootDir := ProjectRootFromExe;
  PyEmbed := TPath.Combine(RootDir, 'external_libraries\python-3.11.9-embed-amd64');
  PyApp   := TPath.Combine(RootDir, 'app_py');

  FPython := TPythonEngine.Create(nil);
  FPython.UseLastKnownVersion := False;
  FPython.DllName    := 'python311.dll';
  FPython.PythonHome := PyEmbed;

  SetDllDirectory(PChar(PyEmbed));
  FPython.LoadDll;

  AddToSysPath(PyApp);
end;

destructor TPyEngineService.Destroy;
begin
  FPython.Free;
  inherited;
end;

procedure TPyEngineService.AddToSysPath(const Path: string);
begin
  GetPythonEngine.EvalString(
    Format('import sys; p=r"%s"; ' +
           'sys.path.insert(0, p) if p not in sys.path else None', [Path])
  );
end;

function TPyEngineService.ProjectRootFromExe: string;
var
  AppDir: string;
begin
  AppDir := TPath.GetDirectoryName(ParamStr(0));
  Result := TDirectory.GetParent(TDirectory.GetParent(TDirectory.GetParent(AppDir)));
end;

procedure TPyEngineService.EnsureReady;
begin
  if (FPython <> nil) and not FPython.IsHandleValid then
    FPython.LoadDll;
end;

initialization
  PyEngineService := TPyEngineService.Create;

finalization
  PyEngineService.Free;

end.

